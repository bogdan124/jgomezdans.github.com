<!DOCTYPE html>
<html lang="en">
<head>
<!-- Using MathJax, with the delimiters $ -->
<!-- Conflict with pygments for the .mo and .mi -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
        <title>Downsampling with GDAL in python</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="A Pelican Blog Atom Feed" />
        
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

        <header id="banner" class="body">
                <h1><a href=".">A Pelican Blog </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li class="active"><a href="./category/blog.html">Blog</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
        
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="downsampling-with-gdal-in-python.html" rel="bookmark"
           title="Permalink to Downsampling with GDAL in python">Downsampling with GDAL in python</a></h1>
      
    </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2012-10-04T13:00:00">
                Thu 04 October 2012
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href="./author/j-gomez-dans.html">J GÃ³mez-Dans</a>
        </address>
        
<p>In <a href="./category/blog.html">Blog</a>. </p>
<p>tags: <a href="./tag/gdal.html">GDAL</a><a href="./tag/remote-sensing.html">remote sensing</a><a href="./tag/python.html">python</a><a href="./tag/tips.html">tips</a></p>


</footer><!-- /.post-info -->
      <p>Quite often, one wants to generate some data at high resolution (say
process some image or images) and then calculate some relevant spatial
statistics at some other resolution. For example, you might want to
process Landsat TM data at 30m resolution, and might want to aggregate
it to a resolution of 500m or so to compare with MODIS. The aggregation
needs to be defined: do you want to use a simple average, or maybe
the mode is more informative? Perhaps the median is more robust to
outliers? Do you want to consider stuff like variance? At any rate,
it is possible to do all this with Python and the GDAL bidings.</p>
<p>The scheme I propose is to create an <em>in-memory</em> raster dataset with the
high resolution data that we want to process. Then we use then <cite>gdal.RegenerateOverviews</cite>
function to do the downsampling.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">downsample_output</span> <span class="p">(</span> <span class="n">g</span><span class="p">,</span> <span class="n">fname_out</span><span class="p">,</span> <span class="n">hires_data</span> <span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;This function downsamples, using the **mode**, the 2D array</span>
<span class="sd">      `hires_data`. The datatype is assumed byte in this case, and</span>
<span class="sd">      you might want to change that. The output files are given by</span>
<span class="sd">      `fname_out`, and we downsample by a factor of 100 and 300. The</span>
<span class="sd">      initial GDAL dataset is `g` (this is where the data are coming</span>
<span class="sd">      from, and we use that to fish out the resolution, geotransform,</span>
<span class="sd">      etc.).</span>

<span class="sd">      NOTE that this is fairly specialised a function, and you might</span>
<span class="sd">      want to have more flexiblity by adding options to deal with</span>
<span class="sd">      the aggregation procedure in `gdal.RegenerateOverviews`, the</span>
<span class="sd">      resolutions of the aggregations you want, the datatypes, etc.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c"># Create an in-memory GDAL dataset to store the full resolution</span>
      <span class="c"># dataset...</span>
      <span class="n">total_obs</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">RasterCount</span>
      <span class="n">drv</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span> <span class="s">&quot;MEM&quot;</span> <span class="p">)</span>
      <span class="n">dst_ds</span> <span class="o">=</span> <span class="n">drv</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> \
          <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Byte</span> <span class="p">)</span>
      <span class="n">dst_ds</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span> <span class="n">g</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>
      <span class="n">dst_ds</span><span class="o">.</span><span class="n">SetProjection</span> <span class="p">(</span> <span class="n">g</span><span class="o">.</span><span class="n">GetProjectionRef</span><span class="p">()</span> <span class="p">)</span>
      <span class="n">dst_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">WriteArray</span> <span class="p">(</span> <span class="n">hires_data</span> <span class="p">)</span>

      <span class="n">geoT</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
      <span class="n">drv</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span> <span class="s">&quot;GTiff&quot;</span> <span class="p">)</span>
      <span class="n">resampled_3k</span> <span class="o">=</span> <span class="n">drv</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_3k.tif&quot;</span> <span class="o">%</span> <span class="n">fname_out</span><span class="p">,</span> \
          <span class="n">g</span><span class="o">.</span><span class="n">RasterXSize</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">RasterYSize</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Byte</span> <span class="p">)</span>
      <span class="n">resampled_9k</span> <span class="o">=</span> <span class="n">drv</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_9k.tif&quot;</span> <span class="o">%</span> <span class="n">fname_out</span><span class="p">,</span> \
          <span class="n">g</span><span class="o">.</span><span class="n">RasterXSize</span><span class="o">/</span><span class="mi">300</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">RasterYSize</span><span class="o">/</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Byte</span> <span class="p">)</span>

      <span class="n">this_geoT</span> <span class="o">=</span> <span class="p">(</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">300</span><span class="p">,</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> \
              <span class="n">geoT</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">300</span> <span class="p">)</span>
      <span class="n">resampled_9k</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span> <span class="n">this_geoT</span> <span class="p">)</span>
      <span class="n">resampled_9k</span><span class="o">.</span><span class="n">SetProjection</span> <span class="p">(</span> <span class="n">g</span><span class="o">.</span><span class="n">GetProjectionRef</span><span class="p">()</span> <span class="p">)</span>

      <span class="n">this_geoT</span> <span class="o">=</span> <span class="p">(</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> \
              <span class="n">geoT</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">geoT</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span> <span class="p">)</span>
      <span class="n">resampled_3k</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span> <span class="n">this_geoT</span> <span class="p">)</span>
      <span class="n">resampled_3k</span><span class="o">.</span><span class="n">SetProjection</span> <span class="p">(</span> <span class="n">g</span><span class="o">.</span><span class="n">GetProjectionRef</span><span class="p">()</span> <span class="p">)</span>
      <span class="n">resampled_3k</span><span class="o">.</span><span class="n">SetMetadata</span> <span class="p">({</span><span class="s">&quot;TotalNObs&quot;</span><span class="p">:</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">total_obs</span><span class="p">})</span>

      <span class="n">gdal</span><span class="o">.</span><span class="n">RegenerateOverviews</span> <span class="p">(</span> <span class="n">dst_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> \
          <span class="p">[</span> <span class="n">resampled_3k</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> \
          <span class="n">resampled_9k</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">],</span>
          <span class="s">&#39;mode&#39;</span> <span class="p">)</span>

      <span class="n">resampled_3k</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span> <span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="n">resampled_9k</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">SetNoDataValue</span> <span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="n">resampled_3k</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">resampled_9k</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
<p>Here's how the above code works on resampling some 30m Landsat TM/ETM+
data</p>
<div class="figure">
<img alt="images/downsample_example.png" src="static/images/downsample_example.png" style="width: 90%;" />
<p class="caption">The left handside plot shows the original 30m resolution dataset. The
middle plot shows a 3km modal aggregation, whereas the right handside
plot shows a 9km modal aggregate.</p>
</div>

    </div><!-- /.entry-content -->
    

  </article>
</section>

        <section id="extras" class="body">
        
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->




</body>
</html>