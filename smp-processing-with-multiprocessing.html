<!DOCTYPE html>
<html lang="en">
<head>
<!-- Using MathJax, with the delimiters $ -->
<!-- Conflict with pygments for the .mo and .mi -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']],processEscapes: true}
  });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
        <title>SMP processing with multiprocessing</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="EO & DA ramblings Atom Feed" />
        
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

<a href="http://github.com/jgomezdans">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

        <header id="banner" class="body">
                <h1><a href=".">EO & DA ramblings </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li class="active"><a href="./category/blog.html">Blog</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
        
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="smp-processing-with-multiprocessing.html" rel="bookmark"
           title="Permalink to SMP processing with multiprocessing">SMP processing with multiprocessing</a></h1>
      
    </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2013-05-23T17:00:00">
                Thu 23 May 2013
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href="./author/j-gomez-dans.html">J GÃ³mez-Dans</a>
        </address>
        
<p>In <a href="./category/blog.html">Blog</a>. </p>
<p>tags: <a href="./tag/python.html">python</a><a href="./tag/gdal.html">gdal</a><a href="./tag/tips.html">tips</a></p>


</footer><!-- /.post-info -->
      <p>This note details how to use parallel processing in python accessing
shared memory. The usage case is when you have a process that reads in a
lot of data, and where the data can be processed in parallel, such as
when reading and processing images/stacks of images in a pixel by pixel
basis.</p>
<p>Critically, we want to avoid making lots of copies of the data to
distribute to the individual processes. To do this, we need to use the
<tt class="docutils literal">multiprocessing</tt> module and the <tt class="docutils literal">sharedmem</tt> module. The latter just
makes using shared memory much more user friendly.</p>
<div class="section" id="the-example">
<h2>The example</h2>
<p>One possible example is the calculation of the typical <em>maximum value
composite</em> from MODIS data. This means that the value of NDVI is
calculated for each observation within a temporal period, and the
maximum value within that time period is reported. The processing is
clearly pixel-by-pixel, so we could think of running the processing on
different cores working on different pixels or different windows of the
image. The main loop looks like this</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">worker</span> <span class="p">(</span> <span class="n">red</span><span class="p">,</span> <span class="n">nir</span><span class="p">,</span> <span class="n">ndvi</span><span class="p">,</span> <span class="n">chunk</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process a chunk of the image stack.</span>

<span class="sd">    This function first calculates a window of rows</span>
<span class="sd">    which is directed by the value of `chunk`. Each</span>
<span class="sd">    worker processes 20 at a time, and this is</span>
<span class="sd">    reflected in the `row_slice` variable. It then</span>
<span class="sd">    loops over the 37 *dekads* in a year, taking into</span>
<span class="sd">    account the last period is only 5 days, and defines</span>
<span class="sd">    a new slice object, `time_slice`. For each period and</span>
<span class="sd">    spatial chunk, the ndvi for each day is calculated,</span>
<span class="sd">    and the maximum value is then stored in the ndvi</span>
<span class="sd">    array for the appropriate period.</span>

<span class="sd">    Note how we don&#39;t return any results here, we are</span>
<span class="sd">    modifying ndvi **in-place** in memory&quot;&quot;&quot;</span>

    <span class="c"># We do 20 lines each time</span>
    <span class="n">row_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span> <span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">chunk</span><span class="p">):((</span><span class="n">chunk</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span> <span class="p">]</span>
    <span class="c"># This is the time loop: 37 periods per year</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">37</span><span class="p">):</span>
        <span class="c"># Start position</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">10</span>
        <span class="c"># End position</span>
        <span class="n">iend</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
        <span class="c"># Correct for last period</span>
        <span class="k">if</span> <span class="n">iend</span> <span class="o">&gt;</span> <span class="n">nir</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">iend</span> <span class="o">=</span> <span class="n">nir</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Define the temporal slice for easier coding</span>
        <span class="n">time_slice</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span>
        <span class="c"># calculates NDVI and stores it in `the_val`</span>
        <span class="n">the_val</span> <span class="o">=</span> <span class="n">nir</span><span class="p">[</span><span class="n">time_slice</span><span class="p">,</span> <span class="p">:,</span> <span class="n">row_slice</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="n">red</span><span class="p">[</span><span class="n">time_slice</span><span class="p">,</span> <span class="p">:,</span> <span class="n">row_slice</span><span class="p">]</span>
        <span class="n">the_val</span> <span class="o">=</span> <span class="n">the_val</span> <span class="o">/</span><span class="p">(</span><span class="mf">1.0e-12</span> <span class="o">+</span> \
                    <span class="n">nir</span><span class="p">[</span><span class="n">time_slice</span><span class="p">,</span> <span class="p">:,</span> <span class="n">row_slice</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">red</span><span class="p">[</span><span class="n">time_slice</span><span class="p">,</span> <span class="p">:,</span> <span class="n">row_slice</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">the_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">the_val</span> <span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> \
            <span class="n">the_val</span> <span class="p">)</span>
        <span class="c"># Take maximum value and store it</span>
        <span class="n">ndvi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">row_slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_val</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
<p>The worker above will get the data, modify one of the arrays in place
<tt class="docutils literal">ndvi</tt> and return. The multiprocessing mechanism is the one in charge
of distributing the load. Let's see how this is done.</p>
<p>First, we need to import some stuff</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>

<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<span class="kn">import</span> <span class="nn">sharedmem</span> <span class="kn">as</span> <span class="nn">shm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</pre></div>
<p>Now, we need a data reader. We'll use some data lying around on UCL for
simplicity</p>
<div class="highlight"><pre><span class="n">N</span><span class="o">=</span><span class="mi">2400</span>

<span class="k">print</span> <span class="s">&quot;[</span><span class="si">%s</span><span class="s">] Reading RED...&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="n">red</span> <span class="o">=</span> <span class="n">shm</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">365</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">&quot;brdf_2004_b01.vrt&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">365</span><span class="p">):</span>
    <span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span><span class="o">/</span><span class="mf">10000.</span>
<span class="k">print</span> <span class="s">&quot;[</span><span class="si">%s</span><span class="s">] Read RED...&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;[</span><span class="si">%s</span><span class="s">] Reading NIR...&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="n">nir</span> <span class="o">=</span> <span class="n">shm</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">365</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">&quot;brdf_2004_b02.vrt&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">365</span><span class="p">):</span>
    <span class="n">nir</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span><span class="o">/</span><span class="mf">10000.</span>
<span class="k">print</span> <span class="s">&quot;[</span><span class="si">%s</span><span class="s">] Read NIR...&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="c"># Output data</span>
<span class="n">ndvi</span><span class="o">=</span><span class="n">shm</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">37</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">print</span> <span class="s">&quot;[</span><span class="si">%s</span><span class="s">] Spreading chunks!&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>
<p>The previous code basically just sets to <tt class="docutils literal">sharedmem</tt> arrays, <tt class="docutils literal">red</tt>
and <tt class="docutils literal">nir</tt>, and reads data into them. Note that we specify the
datatype, but otherwise, they could just be <tt class="docutils literal">np.zeros</tt> incantations.
The reading process can take several minutes if started from cold (i.e.
data not on disk cache).</p>
<p>The next step is to actually spread the load over the different cores.
We have assumed that we'd be doing 20 rows/cols at a time, so we'll have
2400/20 = 120 windows to process. The code is straightforward</p>
<div class="highlight"><pre><span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2400</span><span class="o">/</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">nir</span><span class="p">,</span> <span class="n">ndvi</span><span class="p">,</span><span class="n">i</span><span class="p">,))</span>
    <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
    <span class="n">j</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;[</span><span class="si">%s</span><span class="s">] Done chunking&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>
<p>The only weird bit is the <tt class="docutils literal">join</tt>: this is done to wait for the
processes that might not have finished. After this is done, we get the
processed data in the <tt class="docutils literal">ndvi</tt> array. During this process, you can look
at the output from <tt class="docutils literal">htop</tt> to see how bad the CPU banging is.</p>
<div class="highlight"><pre><span class="p">[</span><span class="n">Thu</span> <span class="n">May</span> <span class="mi">23</span> <span class="mi">16</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">20</span> <span class="mi">2013</span><span class="p">]</span> <span class="n">Reading</span> <span class="n">RED</span><span class="o">...</span>
<span class="p">[</span><span class="n">Thu</span> <span class="n">May</span> <span class="mi">23</span> <span class="mi">16</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">43</span> <span class="mi">2013</span><span class="p">]</span> <span class="n">Read</span> <span class="n">RED</span><span class="o">...</span>
<span class="p">[</span><span class="n">Thu</span> <span class="n">May</span> <span class="mi">23</span> <span class="mi">16</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">43</span> <span class="mi">2013</span><span class="p">]</span> <span class="n">Reading</span> <span class="n">NIR</span><span class="o">...</span>
<span class="p">[</span><span class="n">Thu</span> <span class="n">May</span> <span class="mi">23</span> <span class="mi">16</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mo">04</span> <span class="mi">2013</span><span class="p">]</span> <span class="n">Read</span> <span class="n">NIR</span><span class="o">...</span>
<span class="p">[</span><span class="n">Thu</span> <span class="n">May</span> <span class="mi">23</span> <span class="mi">16</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mo">04</span> <span class="mi">2013</span><span class="p">]</span> <span class="n">Spreading</span> <span class="n">chunks</span><span class="err">!</span>
<span class="p">[</span><span class="n">Thu</span> <span class="n">May</span> <span class="mi">23</span> <span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">36</span> <span class="mi">2013</span><span class="p">]</span> <span class="n">Done</span> <span class="n">chunking</span>
</pre></div>
</div>
<div class="section" id="finally">
<h2>Finally...</h2>
<p>So, in a nutshell, what one needs to do is:</p>
<ol class="arabic simple">
<li>Create the <tt class="docutils literal">sharedmem</tt> arrays and populate them</li>
<li>Create a <tt class="docutils literal">worker</tt> function that does the require processing. Just
assume all data is there, and use slicing!</li>
<li>Use <tt class="docutils literal">multiprocessing</tt> to distribute the job, creating a <tt class="docutils literal">Process</tt>
that passes the shared memory arrays, as well as the &quot;chunk&quot;
indicator.</li>
<li>Wait for <tt class="docutils literal">multiprocessing</tt> and use the data!</li>
</ol>
</div>

    </div><!-- /.entry-content -->
    

  </article>
</section>

        <section id="extras" class="body">
        
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-25702318-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>



</body>
</html>